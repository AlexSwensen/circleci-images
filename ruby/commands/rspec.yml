type: command
name: Run rspec tests
description: |
  run rspec tests
steps:
- run:
    name: Run rspec tests
    command: |
      mkdir -p /tmp/test-results/rspec

      if [ "$CIRCLE_NODE_TOTAL" == "1" ]
      then
        bundle exec rspec --format documentation --format RspecJunitFormatter \
          --out /tmp/test-results/rspec/rspec.xml
      else
        TESTFILES=$(picard tests glob "spec/**/*_spec.rb" | picard tests split --split-by=timings)
        if [ -z "$TESTFILES" ]
        then
          echo 'No tests are scheduled to be executed on this node'
          exit 0
        fi

        echo Node is running "$TESTFILES" >/dev/stderr
        bundle exec rspec --format documentation --format RspecJunitFormatter \
          --out /tmp/test-results/rspec/rspec.xml "$TESTFILES"
      fi
    environment:
      RAILS_ENV: test
      RACK_ENV: test

- store_test_results:
    path: /tmp/test-results/rspec
